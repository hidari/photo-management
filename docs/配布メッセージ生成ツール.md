# 配布メッセージ生成ツール

イベントディレクトリの設定ファイルを参照して、各モデルへの配布用メッセージを自動生成し、`distribution.config.toml`に追記するツールです。

## 概要

このツールは、`distribution.config.toml` に記載されたモデル情報とGoogle DriveのダウンロードURLを組み合わせて、SNS等で送信する配布用メッセージを生成し、TOMLファイルの各モデルセクションに`message`フィールドとして追記します。新規声かけ用とフォローアップ用の2種類のテンプレートに対応しており、モデルごとに適切なメッセージが自動生成されます。

## 前提条件

このツールを実行する前に、以下の準備が必要です：

1. **distribution.config.tomlの作成**: `deno task dirs` でイベントディレクトリと設定ファイルを生成済みであること
2. **写真のアップロード完了**: `deno task upload` でGoogle Driveへのアップロードが完了し、各モデルの `download_url` が設定されていること

`download_url` が未設定の場合、エラーが発生します。

## 基本的な使い方

```bash
deno task distribution
```

デフォルトでは、以下の動作をします：

1. `config.ts` の `developedDirectoryBase` から最新のイベントディレクトリを自動検出
2. イベントディレクトリ内の `distribution.config.toml` を読み込み
3. 各モデルへのメッセージを生成
4. `distribution.config.toml` の各モデルに`message`フィールドを追記して更新

## オプション

特定のイベントディレクトリや設定ファイルを指定したい場合は、以下のオプションが利用できます：

```bash
deno task distribution --event-dir /path/to/event/dir --config /path/to/distribution.config.toml
```

### 利用可能なオプション

- `--event-dir`: イベントディレクトリのパスを指定（省略時は最新のディレクトリを自動検出）
- `--config`: 設定ファイル（TOML）のパスを指定（省略時はイベントディレクトリ内のTOMLファイルを自動検出）

## 動作の仕組み

### 1. 設定ファイルの読み込み

`distribution.config.toml` からイベント情報とモデル情報を読み込みます。特に重要なのは以下のフィールドです：

- `event_name`: イベント名（メッセージに挿入されます）
- `models.name`: モデル名
- `models.sns`: モデルのSNSアカウントURL（任意）
- `models.outreach`: 新規に撮影したモデルかどうかのフラグ（true/false）
- `models.download_url`: Google Driveのダウンロードリンク（**必須**）

### 2. テンプレートの選択

各モデルの `outreach` フィールドに応じて、使用するテンプレートが自動的に選択されます：

- `outreach: true` → `templates/MODEL_OUTREACH.eta`（新規のモデル用）
- `outreach: false` → `templates/MODEL_FOLLOW_UP.eta`（継続のモデル用）

### 3. メッセージの生成

選択されたテンプレートに以下の情報を埋め込んでメッセージを生成します：

- モデル名
- イベント名
- ダウンロードURL

### 4. TOMLファイルへの追記

生成されたメッセージを、`distribution.config.toml`の各モデルセクションに`message`フィールドとして追記します。メッセージは複数行リテラル文字列（`'''`で囲まれた形式）で記載されます。

## 出力形式

更新後の `distribution.config.toml` の構造例：

```toml
[[events]]
date = "20251012"
event_name = "アコスタATC"

[[events.models]]
name = "モデルA"
outreach = true
sns = "https://twitter.com/model_a"
download_url = "https://drive.google.com/..."
message = '''
モデルAさん、こんばんは！
アコスタATCで撮影させていただきましたHidariと申します！
改めてアコスタATCお疲れ様でした。
撮影させていただいたお写真のほうが準備できましたのでダウンロードURLをお送りさせていただきます。
なお、データの取り扱いについてのテキストファイル（_README.txt）を同梱しておりますので目を通していただけますと幸いです。

URL: https://drive.google.com/...


また、こちらはお願いになるのですが、僕の方からもSNSにお写真を投稿したいと思っています。
お時間ございましたら、お気に召したもの1枚で結構ですので加工して送り返していただけないでしょうか🙇‍♂️
お手数をおかけしてしまうのですがよろしくお願いいたします！
'''

[[events.models]]
name = "モデルB"
outreach = false
download_url = "https://drive.google.com/..."
message = '''
モデルBさん、こんばんは！
先日のアコスタATC、お疲れ様でした！
撮影したお写真をお渡しする準備ができましたのでお送りいたしますね。
下記URLよりダウンロードをお願いします。

また例によって僕の方でもSNSにお写真を上げたいので、加工後返送いただけると喜びます！
よろしくお願いします！

URL: https://drive.google.com/...
'''
```

## テンプレートのカスタマイズ

メッセージの内容を変更したい場合は、以下のテンプレートファイルを編集してください：

- `templates/MODEL_OUTREACH.eta`: 新規声かけ用メッセージ
- `templates/MODEL_FOLLOW_UP.eta`: フォローアップ用メッセージ

テンプレートは **Eta** テンプレートエンジンを使用しています。詳細な構文については [Eta公式ドキュメント](https://eta.js.org/) を参照してください。

## トラブルシューティング

### エラー: download_urlが設定されていません

```
モデル「○○」のdownload_urlが設定されていません。先にdeno task uploadを実行してください。
```

このエラーは、Google Driveへのアップロードが完了していない場合に発生します。以下の手順で解決してください：

1. `deno task upload` を実行してzipファイルをGoogle Driveにアップロード
2. アップロードが成功すると、`distribution.config.toml` の各モデルに `download_url` が自動的に追記されます
3. 再度 `deno task distribution` を実行

### エラー: イベントディレクトリが見つかりませんでした

`config.ts` の `developedDirectoryBase` パスが正しいか確認してください。または、`--event-dir` オプションで明示的にパスを指定してください。

### エラー: TOMLファイルが見つかりませんでした

指定したイベントディレクトリ内に `distribution.config.toml` が存在するか確認してください。`deno task dirs` を実行して設定ファイルを生成する必要があります。

## テストについて

このツールの機能は `tests/build-distribution.test.ts` で包括的にテストされています。テストには以下が含まれます：

- テンプレートのレンダリング機能
- TOMLファイルへのメッセージ追記機能
- outreachフラグに応じた適切なテンプレート選択
- download_url未設定時のエラーハンドリング
- 複数モデルの処理
- 複数行リテラル文字列形式の検証

テストの実行方法：

```bash
deno task test
```

## ワークフロー例

写真配布の一連の流れ：

```bash
# 1. ディレクトリ構造を作成
deno task dirs

# 2. 各モデルディレクトリに写真を配置（手動）

# 3. zipファイルを作成
deno task archive

# 4. Google Driveにアップロード（download_urlが自動設定される）
deno task upload

# 5. 配布用メッセージを生成してTOMLに追記
deno task distribution

# 6. distribution.config.tomlを開いて、各モデルのmessageフィールドをコピーして送信
```
