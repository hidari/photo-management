# 古いフォルダ削除ツール

Google Drive上の古いイベントフォルダを削除して、ストレージを効率的に管理するツールです。

## 概要

写真配布後、一定期間が経過したイベントフォルダを削除することで:
- Google Driveのストレージ容量を節約
- 不要なファイルの整理
- セキュリティリスクの低減（古い共有リンクの無効化）

このツールには2つのバージョンがあります:
1. **CLI版**: 手動実行、dry-runモード対応
2. **Google Apps Script版**: トリガーによる完全自動実行

## CLI版の使い方

### 基本的な使い方

```bash
# 削除対象を確認(dry-run)
deno task cleanup

# 実際に削除を実行
deno task cleanup --execute

# 保持期間を変更(60日)
deno task cleanup --execute --days 60

# ヘルプを表示
deno task cleanup --help
```

### 保持期間の設定

保持期間は以下の順で決定されます:

1. `--days` オプション（コマンドライン引数）
2. `config.ts` の `distributionRetentionDays`
3. デフォルト値（30日）

**config.tsでの設定例:**

```typescript
export default {
  // 既存の設定...

  distributionRetentionDays: 45, // 45日間保持
} satisfies Config;
```

### dry-runモード

デフォルトではdry-runモードで動作します。削除対象を確認してから実行できます:

```bash
$ deno task cleanup

🗑️  古いイベントフォルダ削除ツール

🔐 Google Drive認証を確認中...
   👤 認証アカウント: your-email@gmail.com
   ✅ 認証完了

📁 PhotoDistributionフォルダ (ID: xxxxx)

⏰ 保持期間: 30日

🔍 削除対象のフォルダを検索中...
   ⚠️  2個のフォルダが削除対象です:

   • 20240915_古いイベント
     作成日: 2024-09-15
     経過日数: 45日

   • 20240920_さらに古いイベント
     作成日: 2024-09-20
     経過日数: 40日

📝 実際に削除するには --execute オプションを付けて実行してください:
   deno task cleanup --execute
```

### 実行モード

`--execute` オプションで実際に削除を実行:

```bash
$ deno task cleanup --execute

🗑️  古いイベントフォルダ削除ツール

# ... 認証確認 ...

✅ 2個のフォルダを削除しました:

   • 20240915_古いイベント
     作成日: 2024-09-15
     経過日数: 45日

   • 20240920_さらに古いイベント
     作成日: 2024-09-20
     経過日数: 40日

🎉 クリーンアップが完了しました!
```

## Google Apps Script版の使い方

トリガーで定期的に自動実行することで、運用の手間を削減できます。

### セットアップ

詳細なセットアップ手順は [`apps-script/README.md`](../apps-script/README.md) を参照してください。

**概要:**

1. Google Apps Scriptエディタで新規プロジェクトを作成
2. `apps-script/cleanup-scheduler.gs` の内容をコピー
3. スクリプト内の設定を編集:
   ```javascript
   const PHOTO_DISTRIBUTION_FOLDER_ID = 'YOUR_FOLDER_ID_HERE';
   const RETENTION_DAYS = 30;
   const NOTIFICATION_EMAIL = 'your-email@example.com';
   ```
4. テスト実行（`testCleanup`関数）
5. トリガーを設定（例: 毎日午前2時実行）

### 機能

**自動削除:**
- トリガーで設定した時刻に毎日自動実行
- 削除前の確認は不要（完全自動）
- エラー発生時も自動的に処理

**メール通知:**
- 削除実行後に結果をメールで通知
- 削除されたフォルダの一覧を含む
- エラーが発生した場合も通知

**実行ログ:**
- Googleスプレッドシートに実行履歴を記録（オプション）
- 実行日時、削除数、削除フォルダ名、エラー数を記録

### CLI版とGoogle Apps Script版の比較

| 機能 | CLI版 | Google Apps Script版 |
|------|-------|---------------------|
| 実行方式 | 手動実行 | 完全自動(トリガー) |
| 確認プロンプト | あり(--execute必要) | なし |
| dry-runモード | あり | なし(testCleanup関数) |
| メール通知 | なし | あり |
| ログ記録 | コンソール | スプレッドシート |
| 実行環境 | ローカル | Google Cloud |
| 認証 | OAuth 2.0 | Google Apps Script |

## 実行内容

スクリプトは以下の動作をします:

1. OAuth 2.0 認証を確認（CLI版のみ）
2. PhotoDistributionフォルダ内のイベントフォルダを一覧取得
3. 各フォルダの作成日時を確認
4. 保持期間より古いフォルダを抽出
5. 削除を実行（または削除対象を表示）
6. 結果を表示（CLI版）またはメール通知（Apps Script版）

### 削除対象の判定

フォルダの**作成日時**を基準に判定します:

```
現在日時 - フォルダ作成日時 > 保持期間
```

例: 保持期間30日の場合
- 作成から31日経過 → 削除対象
- 作成から29日経過 → 削除対象外

## ストレージ容量の目安

**Google Drive無料枠**: 15GB

**写真配布の例:**
- 1イベントあたり: 5モデル × 50枚 × 5MB = 約1.25GB
- 30日保持の場合: 月2イベント想定で約2.5GB
- 十分に余裕があります

**削除の効果:**
- 定期的に削除することで、使用容量を一定に保てる
- 古い共有リンクが無効化され、セキュリティ向上

## 注意事項

### CLI版

- PhotoDistributionフォルダのIDは自動的に検出されます
- 初回実行時は`deno task upload-folders`を先に実行してください

### Google Apps Script版

- **完全自動で動作**: 削除前の確認プロンプトはありません
- **ゴミ箱に移動**: 削除されたフォルダはゴミ箱に移動されます（30日後に完全削除）
- **復元可能**: 誤削除の場合、Google Driveのゴミ箱から復元できます

## トラブルシューティング

### PhotoDistributionフォルダIDが見つからない

```
❌ エラー: PhotoDistributionフォルダIDが見つかりません
```

**対処法:**
```bash
# 先にアップロードツールを実行してフォルダを作成
deno task upload-folders
```

### 認証エラーが発生する（CLI版）

[Google Driveアップロードツール](./Google%20Driveアップロードツール.md#トラブルシューティング)のトラブルシューティングを参照してください。

### 権限エラーが発生する（Apps Script版）

- スクリプトを実行するアカウントがPhotoDistributionフォルダにアクセスできることを確認
- トリガーの実行アカウントが正しいか確認

### メール通知が届かない（Apps Script版）

- `NOTIFICATION_EMAIL`が正しく設定されているか確認
- スパムフォルダを確認
- Gmail以外のメールアドレスの場合、遅延する可能性があります

### ログが記録されない（Apps Script版）

- `LOG_SPREADSHEET_ID`が正しく設定されているか確認
- スプレッドシートへのアクセス権限を確認
- スプレッドシートが削除されていないか確認

## 運用のベストプラクティス

### 保持期間の設定

推奨: **30日**

理由:
- モデルがダウンロードする十分な時間
- ストレージ容量を適度に節約
- 古い共有リンクのセキュリティリスク低減

### 削除のタイミング

**CLI版の場合:**
- イベント後1ヶ月経過時に手動実行
- または月1回の定期メンテナンスで実行

**Google Apps Script版の場合:**
- 毎日午前2時など、アクセスが少ない時間帯に自動実行
- メール通知で削除内容を確認

### モデルへの事前通知

配布メッセージに保持期限を明記することで、モデルに事前に知らせることができます:

```
⏰ このフォルダは配布から30日後に削除予定です。
   必要な写真は期限内に保存をお願いします。
```

これは`templates/MODEL_OUTREACH.eta`と`templates/MODEL_FOLLOW_UP.eta`に自動的に含まれています。

## 関連ドキュメント

- [Google Driveフォルダ共有アップロードツール](./Google%20Driveフォルダ共有アップロードツール.md)
- [Google Apps Scriptセットアップ手順](../apps-script/README.md)
- [配布メッセージ生成ツール](./配布メッセージ生成ツール.md)
