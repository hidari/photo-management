# SNS投稿メッセージ生成システム - セットアップガイド

このドキュメントでは、Google SpreadsheetとGoogle Apps Scriptを使用した、SNS投稿メッセージ生成システムのセットアップ手順を説明します。

## 前提条件

- Googleアカウント
- Google Drive へのアクセス
- Google Spreadsheet の基本的な操作知識

## セットアップ手順

### 1. スプレッドシートの準備

#### 1.1 新規スプレッドシートの作成

Google Drive上で新しいスプレッドシートを作成します。

#### 1.2 列ヘッダーの設定

1行目に以下のヘッダーを設定します：

| A  | B    | C           | D     | E         | F          | G             | H                       | I     | J       | K         |
|----|------|-------------|-------|-----------|------------|---------------|-------------------------|-------|---------|-----------|
| ID | FILE | PHOTO_TITLE | TITLE | CHARACTER | MODEL_NAME | MODEL_ACCOUNT | OPTIONAL_EVENT_HASHTAGS | READY | MESSAGE | PUBLISHED |

**各列の説明**：

- ID: 写真の識別番号（必須）
- FILE: 写真ファイル名（必須）
- PHOTO_TITLE: 写真のタイトル（必須）
- TITLE: 作品タイトル（必須）
- CHARACTER: キャラクター名（必須）
- MODEL_NAME: モデル名（必須）
- MODEL_ACCOUNT: モデルのXアカウント（@付き）（必須）
- OPTIONAL_EVENT_HASHTAGS: イベントハッシュタグ（スペース区切り）（任意）
- READY: メッセージ生成対象フラグ（TRUE/FALSE）
- MESSAGE: 生成されたメッセージ（自動入力）
- PUBLISHED: 投稿完了フラグ（TRUE/FALSE）

#### 1.3 条件付き書式の設定（推奨）

READY列（I列）に条件付き書式を設定して、必須項目が未入力の場合に警告色で表示します。

1. I列全体を選択
2. 「表示形式」→「条件付き書式」
3. 条件を追加：
   - カスタム数式: `=OR(ISBLANK($A2), ISBLANK($B2), ISBLANK($C2), ISBLANK($D2), ISBLANK($E2), ISBLANK($F2), ISBLANK($G2))`
   - 書式スタイル: 任意の警告色を設定
4. 「完了」をクリック

### 2. POST.txtテンプレートの準備

#### 2.1 テンプレートファイルの作成

スプレッドシートと同じGoogle Driveフォルダに `POST.txt` という名前のテキストファイルを作成します。

#### 2.2 テンプレート内容

以下の内容をコピー＆ペーストします：

```
CosPhoto:『 ${PHOTO_TITLE} 』

Title: ${TITLE}
Character: ${CHARACTER}

Model. ${MODEL_ACCOUNT}
Photo. Hidari
At. ${OPTIONAL_EVENT_HASHTAGS}
Discover more → #HidariPhoto
```

> プレースホルダー以外は任意に変更可能ですが、動作に支障が出た場合はコードの修正が必要になります。

**変数の説明**：
- `${PHOTO_TITLE}`: 写真のタイトルに置換されます
- `${TITLE}`: 作品タイトルに置換されます
- `${CHARACTER}`: キャラクター名に置換されます
- `${MODEL_NAME}`: モデル名に置換されます
- `${MODEL_ACCOUNT}`: モデルのXアカウントに置換されます
- `${OPTIONAL_EVENT_HASHTAGS}`: イベントハッシュタグに置換されます
  - 空の場合、`At.` で始まる行全体が削除されます

#### 2.3 ファイルIDの取得

**方法1: 共有リンクから取得（推奨）**

1. POST.txtファイルを右クリック → 「共有」→ 「リンクをコピー」
2. コピーしたURLから ファイルID を抽出します
   - URL形式: `https://drive.google.com/file/d/{ファイルID}/view?usp=sharing`
   - 例: `1aBcDeFgHiJkLmNoPqRsTuVwXyZ123456789`
   - `/d/` と `/view` の間の文字列がファイルIDです
3. ファイルIDをメモ帳などに保存しておきます

**方法2: ファイル詳細から取得**

1. POST.txtファイルを右クリック → 「詳細を表示」
2. 右側のパネルに表示される情報から「リンクをコピー」をクリック
3. 方法1と同様にURLからファイルIDを抽出します

**方法3: ファイルを開いた場合**

1. POST.txtファイルをダブルクリックで開く
2. ブラウザのアドレスバーに表示されるURLからファイルIDをコピー
   - プレビュー表示の場合でもURLにファイルIDが含まれています

### 3. Google Apps Script の設定

#### 3.1 Apps Script エディタを開く

1. スプレッドシートで「拡張機能」→「Apps Script」をクリック
2. 新しいタブでApps Script エディタが開きます

#### 3.2 スクリプトコードのコピー

1. リポジトリの `apps-script/src/message-generator.ts` を `tsc` でトランスパイルする
2. 生成された `apps-script/dist/message-generator.js` を開き内容をコピーする
3. 全内容をコピー
4. Apps Script エディタの `コード.gs` にペースト
5. 「保存」アイコンをクリック（Ctrl/Cmd + S）

#### 3.3 スクリプト プロパティの設定

1. Apps Script エディタで「プロジェクトの設定」（歯車アイコン）をクリック
2. 「スクリプト プロパティ」セクションまでスクロール
3. 「スクリプト プロパティを追加」をクリック
4. 以下の値を設定：
   - プロパティ: `POST_TEMPLATE_FILE_ID`
   - 値: 先ほどコピーしたPOST.txtのファイルID
5. 「スクリプト プロパティを保存」をクリック

#### 3.4 権限の承認

1. Apps Script エディタで「実行」ボタン（▶️）をクリックして `onOpen` 関数を実行
2. 「権限を確認」ダイアログが表示されたら「権限を確認」をクリック
3. Googleアカウントを選択
4. 「詳細」→「（プロジェクト名）に移動（安全ではないページ）」をクリック
5. 「許可」をクリック

### 4. 動作確認

#### 4.1 カスタムメニューの確認

1. スプレッドシートのタブに戻る
2. ページを再読み込み（F5 または Ctrl/Cmd + R）
3. メニューバーに「📝 メッセージ生成」メニューが追加されていることを確認

#### 4.2 テストデータの入力

以下のようなテストデータを2行目に入力します：

| A | B        | C        | D                   | E            | F      | G             | H           | I    |
|---|----------|----------|---------------------|--------------|--------|---------------|-------------|------|
| 1 | test.jpg | Ethereal | 原神 - Genshin Impact | ダリア - Dahlia | テストモデル | @test_account | #C105 #コスホリ | TRUE |

#### 4.3 メッセージ生成の実行

1. 「📝 メッセージ生成」→「メッセージを生成する」をクリック
2. 「1件のメッセージを生成しました。」というダイアログが表示されることを確認
3. J列（MESSAGE列）に生成されたメッセージが書き込まれていることを確認

#### 4.4 生成されたメッセージの例

```
CosPhoto:『 Ethereal 』

Title: 原神 - Genshin Impact
Character: ダリア - Dahlia

Model. @test_account
Photo. Hidari
At. #C105 #コスホリ
Discover more → #HidariPhoto
```

## 使用方法

### メッセージ生成フロー

1. データ入力: スプレッドシートに写真情報を入力（A-H列）
2. READY設定: メッセージを生成したい行のREADY列（I列）に `TRUE` を入力
3. メッセージ生成: 「📝 メッセージ生成」→「メッセージを生成する」を実行
4. 確認: MESSAGE列（J列）に生成されたメッセージを確認
5. 投稿: MESSAGEをコピーして、Xに手動で投稿（写真も添付）
6. 完了マーク: 投稿後、PUBLISHED列（K列）に `TRUE` を入力

### スマートフォンからの実行

Google Sheetsモバイルアプリでも実行可能です：

1. Google Sheetsアプリでスプレッドシートを開く
2. 右上の「⋮」メニューをタップ
3. 「📝 メッセージ生成」→「メッセージを生成する」をタップ

## トラブルシューティング

### エラー: 「POST.txtのファイルIDが設定されていません」

原因: スクリプト プロパティに `POST_TEMPLATE_FILE_ID` が設定されていない

解決方法: 「3.3 スクリプト プロパティの設定」を参照して設定してください

### エラー: 「POST.txtファイルを読み込めませんでした」

原因:
- ファイルIDが間違っている
- POST.txtファイルが削除された
- ファイルへのアクセス権限がない

解決方法:
1. POST.txtファイルがGoogle Driveに存在するか確認
2. ファイルIDが正しいか確認
3. ファイルの共有設定を確認（自分がオーナーまたは編集権限を持っているか）

### メッセージ: 「対象行が見つかりませんでした」

原因:
- READY列が `TRUE` になっていない
- 必須項目（A-H列）のいずれかが空白

解決方法:
1. READY列（I列）に `TRUE` と入力されているか確認
2. A-H列のすべてに値が入力されているか確認
3. 条件付き書式を設定している場合、警告色になっていないか確認

### カスタムメニューが表示されない

原因: スクリプトが正しく実行されていない

解決方法:
1. スプレッドシートを再読み込み（F5 または Ctrl/Cmd + R）
2. Apps Script エディタで `onOpen` 関数を手動実行
3. それでも表示されない場合、スクリプトにエラーがないか確認

## よくある質問

### Q: テンプレートを変更したい

A: POST.txtファイルを編集してください。次回のメッセージ生成時から反映されます。

### Q: 複数のテンプレートを使い分けたい

A: 現在のバージョンでは1つのテンプレートのみ対応しています。将来的な拡張として検討中です。

### Q: 生成されたメッセージは上書きされますか？

A: いいえ。`MESSAGE` がすでに存在する行はスキップされます。再度メッセージ生成するには、`MESSAGE` を空にしてください。

### Q: X（Twitter）への自動投稿は可能ですか？

A: 現在のバージョンでは手動投稿のみです。将来的には自動投稿機能の追加ができたらいいなと思っています。

### Q: メッセージの文字数制限は？

A: 現在のバージョンでは文字数チェック機能はありません。Xの制限（280字）を超えないよう、手動で確認してください。
