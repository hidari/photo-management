# Google Driveフォルダ共有アップロードツール

> **推奨**: このツールは従来のzip配布の上位互換です。モデルは個別写真を選んでダウンロードでき、フォルダごと一括zipダウンロードも可能です。

個別の写真ファイルをモデルごとのフォルダにアップロードし、フォルダ共有URLを自動取得するツールです。

## zip配布方式との違い

| 項目 | フォルダ共有方式 | zip配布方式 |
|-----|--------------|----------|
| 選択的ダウンロード | ✅ 可能 | ❌ 不可(全ファイル必須) |
| 一括ダウンロード | ✅ 可能(フォルダごとzip) | ✅ 可能 |
| 事前プレビュー | ✅ 可能 | ❌ 不可 |
| スマホストレージ | ✅ 節約可能 | ❌ 全データ必要 |
| 解凍の手間 | ✅ 不要 | ❌ 必要 |
| Google Driveアプリ | ✅ 最適化済み | △ 通常動作 |

## 初回セットアップ

OAuth 2.0 認証のセットアップが必要です。[Google Driveアップロードツール](./Google%20Driveアップロードツール.md)の「初回セットアップ」セクションを参照してください。

**既にzip配布方式で認証済みの場合**: 追加の認証は不要です。同じ認証情報を使用します。

## アップロードの実行

```bash
# 最新のイベントを自動検出してアップロード
deno task upload-folders

# イベントディレクトリを指定
deno task upload-folders --event-dir ./path/to/20251012_アコスタATC

# TOMLファイルを直接指定
deno task upload-folders --config ./path/to/distribution.config.toml
```

## 実行内容

スクリプトは以下の動作をします:

1. OAuth 2.0 認証を確認（必要に応じてブラウザで認証）
2. 認証されている Google アカウントを表示
3. Google Drive 上に「PhotoDistribution」フォルダを自動作成（初回のみ）
4. イベント別のフォルダを作成（非公開）
5. 各モデル用のフォルダを作成し、個別写真をアップロード
6. 各モデルフォルダに個別の共有設定を適用:
   - `allowFileDiscovery: false` により検索結果に表示されない
   - リンクを知っている人のみがアクセス可能
7. フォルダ共有リンクを取得
8. TOMLファイルの各モデルの `download_url` フィールドに共有URLを記録

## フォルダ構成

```
マイドライブ/
└── PhotoDistribution/
    └── 20251012_アコスタATC/              # イベントフォルダ（非公開）
        ├── モデルAさん用フォルダ/          # 個別共有設定
        │   ├── 写真1.jpg
        │   ├── 写真2.jpg
        │   └── ...
        ├── モデルBさん用フォルダ/          # 個別共有設定
        │   ├── 写真1.jpg
        │   └── ...
        └── ...
```

### セキュリティ設計

- **親フォルダは非公開**: イベントフォルダは共有されない
- **子フォルダのみ個別共有**: 各モデルフォルダに独立した共有設定
- **検索除外**: `allowFileDiscovery: false`により検索結果に表示されない
- **他モデルへの遮断**: 各モデルは自分のフォルダにのみアクセス可能

## モデルへの配布メッセージ

自動生成されるメッセージ例:

```
【写真フォルダ】
https://drive.google.com/drive/folders/xxxxx

リンクを開くとフォルダ内の写真を一覧で確認できます。
必要な写真を選んで個別にダウンロードすることも、
フォルダごと一括でzipダウンロードすることもできます。

📱 Google Driveアプリを入れておくと、
   より快適に閲覧・ダウンロードできるのでおすすめです。

⏰ このフォルダは配布から30日後に削除予定です。
   必要な写真は期限内に保存をお願いします。
```

## モデル側の操作方法

### ブラウザでの操作

1. 共有リンクを開く
2. フォルダ内の写真を一覧で確認
3. 個別ダウンロード:
   - 写真を選択 → 右クリック → 「ダウンロード」
4. 一括ダウンロード:
   - フォルダ全体を選択 → メニューから「ダウンロード」
   - 自動的にzipファイルが作成されダウンロード開始

### Google Driveアプリでの操作

1. 共有リンクをタップ
2. 「Google Driveで開く」を選択
3. サムネイル表示で快適に閲覧
4. 個別ダウンロードやオフライン保存が可能
5. SNSへの直接共有も簡単

## エラーハンドリング

アップロード中にエラーが発生した場合:

1. エラー発生時点で作成済みのフォルダIDを記録
2. 自動的にクリーンアップ処理を実行
3. 作成途中のフォルダを逆順（子から親）で削除
4. エラーメッセージを表示して終了
5. 再実行時は最初からやり直し

## 古いフォルダの削除

配布後、古いフォルダは削除してストレージを管理できます:

```bash
# 削除対象を確認(dry-run)
deno task cleanup

# 実際に削除を実行
deno task cleanup --execute
```

詳しくは[古いフォルダ削除ツール](./古いフォルダ削除ツール.md)を参照してください。

## トラブルシューティング

### 認証エラーが発生する

[Google Driveアップロードツール](./Google%20Driveアップロードツール.md#トラブルシューティング)のトラブルシューティングを参照してください。

### 写真ファイルが見つからない

```
❌ エラー: アップロード対象の写真ファイルが見つかりません
```

**対処法**:
1. `deno task dirs` でディレクトリ構造を作成済みか確認
2. DIST_DIRに写真ファイルが配置されているか確認
3. 対応している拡張子: jpg, jpeg, png, gif, bmp, webp

### アップロードが途中で失敗する

エラー発生時は自動的にクリーンアップされます。エラーメッセージを確認し:

1. ネットワーク接続を確認
2. Google Driveのストレージ容量を確認
3. 再実行すると最初からやり直されます

### ストレージ容量が不足する

**無料枠**: Google Driveは15GBまで無料

**対策**:
1. 古いイベントフォルダを定期的に削除
2. `deno task cleanup --execute` で削除
3. Google Apps Scriptで自動削除を設定

## zip配布方式との併用

両方の方式を同時に使用することも可能です:

```bash
# zip配布方式
deno task ship

# フォルダ共有方式
deno task ship-folders
```

TOMLファイルの `download_url` には最後に実行した方のURLが記録されます。

## 関連ドキュメント

- [Google Driveアップロードツール (zip配布方式)](./Google%20Driveアップロードツール.md)
- [古いフォルダ削除ツール](./古いフォルダ削除ツール.md)
- [配布メッセージ生成ツール](./配布メッセージ生成ツール.md)
